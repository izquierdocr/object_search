<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ARNL: arnlJustLocalization.cpp</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ARNL
   &#160;<span id="projectnumber">1.9.0</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('arnlJustLocalization_8cpp-example.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">arnlJustLocalization.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>example server that performs ARNL laser localization but no navigation or path planning.</p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &quot;Aria.h&quot;</span>
<span class="preprocessor">#include &quot;ArNetworking.h&quot;</span>
<span class="preprocessor">#include &quot;Arnl.h&quot;</span>
<span class="preprocessor">#include &quot;ArLocalizationTask.h&quot;</span>
<span class="preprocessor">#include &quot;ArDocking.h&quot;</span>
<span class="preprocessor">#include &quot;ArSystemStatus.h&quot;</span>

<span class="keywordtype">void</span> logOptions(<span class="keyword">const</span> <span class="keywordtype">char</span> *progname)
{
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Usage: %s [options]\n&quot;</span>, progname);
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;[options] are any program options listed below, or any ARNL configuration&quot;</span>);
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;parameters as -name &lt;value&gt;, see params/arnl.p for list.&quot;</span>);
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;For example, -map &lt;map file&gt;.&quot;</span>);
  Aria::logOptions();
}

<span class="keywordtype">bool</span> gyroErrored = <span class="keyword">false</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span>* getGyroStatusString(ArRobot* robot)
{
  <span class="keywordflow">if</span>(!robot || !robot-&gt;getOrigRobotConfig() || robot-&gt;getOrigRobotConfig()-&gt;getGyroType() &lt; 2) <span class="keywordflow">return</span> <span class="stringliteral">&quot;N/A&quot;</span>;
  <span class="keywordflow">if</span>(robot-&gt;getFaultFlags() &amp; ArUtil::BIT4)
  {
    gyroErrored = <span class="keyword">true</span>;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;ERROR/OFF&quot;</span>;
  }
  <span class="keywordflow">if</span>(gyroErrored)
  {
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;OK but error before&quot;</span>;
  }
  <span class="keywordflow">return</span> <span class="stringliteral">&quot;OK&quot;</span>;
}


<span class="comment">// This function is called if localization fails. It will be attached </span>
<span class="comment">// to the localization task below in main() via</span>
<span class="comment">// ArLocalizationTask::setFailedCallback()</span>
<span class="keywordtype">void</span> locFailed(<span class="keywordtype">int</span> n) <span class="comment">//, ArLocalizationTask* locTask)</span>
{
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;ARNL server example: localization failed&quot;</span>);
}
 

<span class="keywordtype">bool</span> handleDebugMessage(ArRobotPacket *pkt)
{
  <span class="keywordflow">if</span>(pkt-&gt;getID() != ArCommands::MARCDEBUG) <span class="keywordflow">return</span> <span class="keyword">false</span>;
  <span class="keywordtype">char</span> msg[256];
  pkt-&gt;bufToStr(msg, <span class="keyword">sizeof</span>(msg));
  msg[255] = 0;
  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Controller Firmware: %s&quot;</span>, msg);
  <span class="keywordflow">return</span> <span class="keyword">true</span>;
}


<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
{
  <span class="comment">// Initialize Aria and Arnl global information</span>
  Aria::init();
  Arnl::init();

  <span class="comment">// You can change default ArLog options in this call, but the settings in the parameter file</span>
  <span class="comment">// (arnl.p) which is loaded below (Aria::getConfig()-&gt;parseFile())  will override the options.</span>
  <span class="comment">//ArLog::init(ArLog::File, ArLog::Normal, &quot;log.txt&quot;, true, true);</span>

  <span class="comment">// Used to parse the command line arguments.</span>
  ArArgumentParser parser(&amp;argc, argv);
  
  <span class="comment">// Load default arguments for this computer (from /etc/Aria.args, environment</span>
  <span class="comment">// variables, and other places)</span>
  parser.loadDefaultArguments();

  <span class="comment">// Tell the laser connector to always connect the first laser since</span>
  <span class="comment">// this program always requires a laser.</span>
  parser.addDefaultArgument(<span class="stringliteral">&quot;-connectLaser&quot;</span>);

  


  <span class="comment">// The robot object</span>
  ArRobot robot;

  <span class="comment">// handle messages from robot controller firmware and log the contents</span>
  robot.addPacketHandler(<span class="keyword">new</span> ArGlobalRetFunctor1&lt;bool, ArRobotPacket*&gt;(&amp;handleDebugMessage));

  <span class="comment">// This object is used to connect to the robot, which can be configured via</span>
  <span class="comment">// command line arguments.</span>
  ArRobotConnector robotConnector(&amp;parser, &amp;robot);

  <span class="comment">// Connect to the robot</span>
  <span class="keywordflow">if</span> (!robotConnector.connectRobot())
  {
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Error: Could not connect to robot... exiting&quot;</span>);
    Aria::exit(3);
  }



  <span class="comment">// Set up where we&#39;ll look for files. Arnl::init() set Aria&#39;s default</span>
  <span class="comment">// directory to Arnl&#39;s default directory; addDirectories() appends this</span>
  <span class="comment">// &quot;examples&quot; directory.</span>
  <span class="keywordtype">char</span> fileDir[1024];
  ArUtil::addDirectories(fileDir, <span class="keyword">sizeof</span>(fileDir), Aria::getDirectory(), 
             <span class="stringliteral">&quot;examples&quot;</span>);
  
  
  <span class="comment">// To direct log messages to a file, or to change the log level, use these  calls:</span>
  <span class="comment">//ArLog::init(ArLog::File, ArLog::Normal, &quot;log.txt&quot;, true, true);</span>
  <span class="comment">//ArLog::init(ArLog::File, ArLog::Verbose);</span>
 
  <span class="comment">// Add a section to the configuration to change ArLog parameters</span>
  ArLog::addToConfig(Aria::getConfig());

  <span class="comment">// set up a gyro (if the robot is older and its firmware does not</span>
  <span class="comment">// automatically incorporate gyro corrections, then this object will do it)</span>
  ArAnalogGyro gyro(&amp;robot);

  <span class="comment">// Our networking server</span>
  ArServerBase server;
  

  <span class="comment">// Set up our simpleOpener, used to set up the networking server</span>
  ArServerSimpleOpener simpleOpener(&amp;parser);

  <span class="comment">// the laser connector</span>
  ArLaserConnector laserConnector(&amp;parser, &amp;robot, &amp;robotConnector);

  <span class="comment">// used to connect to camera PTZ control</span>
  ArPTZConnector ptzConnector(&amp;parser, &amp;robot);

  <span class="comment">// Used to connect to a &quot;central server&quot; which can be used as a proxy </span>
  <span class="comment">// for multiple robot servers, and as a way for them to also communicate with</span>
  <span class="comment">// each other.  (objects implementing some of these inter-robot communication</span>
  <span class="comment">// features are created below).  </span>
  <span class="comment">// NOTE: If the central server is running on the same host as robot server(s),</span>
  <span class="comment">// then you must use the -serverPort argument to instruct these robot-control</span>
  <span class="comment">// server(s) to use different ports than the default 7272, since the central</span>
  <span class="comment">// server will use that port.</span>
  ArClientSwitchManager clientSwitch(&amp;server, &amp;parser);
  
  <span class="comment">// Load default arguments for this computer (from /etc/Aria.args, environment</span>
  <span class="comment">// variables, and other places)</span>
  parser.loadDefaultArguments();

  <span class="comment">// Parse arguments </span>
  <span class="keywordflow">if</span> (!Aria::parseArgs() || !parser.checkHelpAndWarnUnparsed())
  {
    logOptions(argv[0]);
    Aria::exit(1);
  }
  

  <span class="comment">// This causes Aria::exit(9) to be called if the robot unexpectedly</span>
  <span class="comment">// disconnects</span>
  ArGlobalFunctor1&lt;int&gt; shutdownFunctor(&amp;Aria::exit, 9);
  robot.addDisconnectOnErrorCB(&amp;shutdownFunctor);


  <span class="comment">// Create an ArSonarDevice object (ArRangeDevice subclass) and </span>
  <span class="comment">// connect it to the robot.</span>
  ArSonarDevice sonarDev;
  robot.addRangeDevice(&amp;sonarDev);



  <span class="comment">// This object will allow robot&#39;s movement parameters to be changed through</span>
  <span class="comment">// a Robot Configuration section in the ArConfig global configuration facility.</span>
  ArRobotConfig robotConfig(&amp;robot);

  <span class="comment">// Include gyro configuration options in the robot configuration section.</span>
  robotConfig.addAnalogGyro(&amp;gyro);

  <span class="comment">// Start the robot thread.</span>
  robot.runAsync(<span class="keyword">true</span>);

  

  <span class="comment">// connect the laser(s) if it was requested, this adds them to the</span>
  <span class="comment">// robot too, and starts them running in their own threads</span>
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Connecting to laser(s) configured in parameters...&quot;</span>);
  <span class="keywordflow">if</span> (!laserConnector.connectLasers())
  {
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Error: Could not connect to laser(s). Exiting.&quot;</span>);
    Aria::exit(2);
  }
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Done connecting to laser(s).&quot;</span>);

  <span class="comment">// find the laser we should use for localization and/or mapping,</span>
  <span class="comment">// which will be the first laser</span>
  robot.lock();
  ArLaser *firstLaser = robot.findLaser(1);
  <span class="keywordflow">if</span> (firstLaser == NULL || !firstLaser-&gt;isConnected())
  {
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Did not have laser 1 or it is not connected, cannot start localization and/or mapping... exiting&quot;</span>);
    Aria::exit(2);
  }
  robot.unlock();


    <span class="comment">/* Create and set up map object */</span>
  
  <span class="comment">// Set up the map object, this will look for files in the examples</span>
  <span class="comment">// directory (unless the file name starts with a /, \, or .</span>
  <span class="comment">// You can take out the &#39;fileDir&#39; argument to look in the program&#39;s current directory</span>
  <span class="comment">// instead.</span>
  <span class="comment">// When a configuration file is loaded into ArConfig later, if it specifies a</span>
  <span class="comment">// map file, then that file will be loaded as the map.</span>
  ArMap map(fileDir);
  <span class="comment">// set it up to ignore empty file names (otherwise if a configuration omits</span>
  <span class="comment">// the map file, the whole configuration change will fail)</span>
  map.setIgnoreEmptyFileName(<span class="keyword">true</span>);
  <span class="comment">// ignore the case, so that if someone is using MobileEyes or</span>
  <span class="comment">// MobilePlanner from Windows and changes the case on a map name,</span>
  <span class="comment">// it will still work.</span>
  map.setIgnoreCase(<span class="keyword">true</span>);

    
    <span class="comment">/* Create localization threads */</span>



  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Creating laser localization task&quot;</span>);
  <span class="comment">// Laser Monte-Carlo Localization</span>
  <a name="_a0"></a><a class="code" href="classArLocalizationTask.html" title="Task that performs continuous localization of the robot with a laser range sensor in a seperate async...">ArLocalizationTask</a> locTask(&amp;robot, firstLaser, &amp;map);
  


  <span class="comment">// A callback function, which is called if localization fails</span>
  ArGlobalFunctor1&lt;int&gt; locFailedCB(&amp;locFailed);
  locTask.setFailedCallBack(&amp;locFailedCB); <span class="comment">//, &amp;locTask);</span>


  <span class="comment">// Set some options  and callbacks on each laser that the laser connector </span>
  <span class="comment">// connected to.</span>
  std::map&lt;int, ArLaser *&gt;::iterator laserIt;
  <span class="keywordflow">for</span> (laserIt = robot.getLaserMap()-&gt;begin();
       laserIt != robot.getLaserMap()-&gt;end();
       laserIt++)
  {
    <span class="keywordtype">int</span> laserNum = (*laserIt).first;
    ArLaser *laser = (*laserIt).second;

    <span class="comment">// Skip lasers that aren&#39;t connected</span>
    <span class="keywordflow">if</span>(!laser-&gt;isConnected())
      <span class="keywordflow">continue</span>;

    <span class="comment">// add the disconnectOnError CB to shut things down if the laser</span>
    <span class="comment">// connection is lost</span>
    laser-&gt;addDisconnectOnErrorCB(&amp;shutdownFunctor);
    <span class="comment">// set the number of cumulative readings the laser will take</span>
    laser-&gt;setCumulativeBufferSize(200);
    <span class="comment">// set the cumulative clean offset (so that they don&#39;t all fire at once)</span>
    laser-&gt;setCumulativeCleanOffset(laserNum * 100);
    <span class="comment">// reset the cumulative clean time (to make the new offset take effect)</span>
    laser-&gt;resetLastCumulativeCleanTime();

    <span class="comment">// Add the packet count to the Aria info strings (It will be included in</span>
    <span class="comment">// MobileEyes custom details so you can monitor whether the laser data is</span>
    <span class="comment">// being received correctly)</span>
    std::string laserPacketCountName;
    laserPacketCountName = laser-&gt;getName();
    laserPacketCountName += <span class="stringliteral">&quot; Packet Count&quot;</span>;
    Aria::getInfoGroup()-&gt;addStringInt(
        laserPacketCountName.c_str(), 10, 
        <span class="keyword">new</span> ArRetFunctorC&lt;int, ArLaser&gt;(laser, 
                     &amp;ArLaser::getReadingCount));
  }





    <span class="comment">/* Start the server */</span>

  <span class="comment">// Open the networking server</span>
  <span class="keywordflow">if</span> (!simpleOpener.open(&amp;server, fileDir, 240))
  {
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Error: Could not open server.&quot;</span>);
    exit(2);
  }



    <span class="comment">/* Create various services that provide network access to clients (such as</span>
<span class="comment">     * MobileEyes), as well as add various additional features to ARNL */</span>


  robot.unlock();



  
  <span class="comment">// Service to provide drawings of data in the map display :</span>
  ArServerInfoDrawings drawings(&amp;server);
  drawings.addRobotsRangeDevices(&amp;robot);

  <span class="comment">/* Show the sample points used by MCL */</span>
  ArDrawingData drawingDataL(<span class="stringliteral">&quot;polyDots&quot;</span>, ArColor(0,255,0), 100, 75);
  ArFunctor2C&lt;ArLocalizationTask, ArServerClient *, ArNetPacket *&gt; 
    drawingFunctorL(&amp;locTask, &amp;<a name="a1"></a><a class="code" href="classArLocalizationTask.html#a106eada91144e31e6c9999f2130bb98f" title="Draws range data used for localization.">ArLocalizationTask::drawRangePoints</a>);
  drawings.addDrawing(&amp;drawingDataL, <span class="stringliteral">&quot;Localization Points&quot;</span>, &amp;drawingFunctorL);


  <span class="comment">// &quot;Custom&quot; commands. You can add your own custom commands here, they will</span>
  <span class="comment">// be available in MobileEyes&#39; custom commands (enable in the toolbar or</span>
  <span class="comment">// access through Robot Tools)</span>
  ArServerHandlerCommands commands(&amp;server);


  <span class="comment">// These provide various kinds of information to the client:</span>
  ArServerInfoRobot serverInfoRobot(&amp;server, &amp;robot);
  ArServerInfoSensor serverInfoSensor(&amp;server, &amp;robot);

  <span class="comment">// Provides localization info and allows the client (MobileEyes) to relocalize at a given</span>
  <span class="comment">// pose:</span>
  <a name="_a2"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArServerInfoLocalization.html">ArServerInfoLocalization</a> serverInfoLocalization(&amp;server, &amp;robot, &amp;locTask);
  <a name="_a3"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArServerHandlerLocalization.html">ArServerHandlerLocalization</a> serverLocHandler(&amp;server, &amp;robot, &amp;locTask);

  <span class="comment">// If you&#39;re using MobileSim, ArServerHandlerLocalization sends it a command</span>
  <span class="comment">// to move the robot&#39;s true pose if you manually do a localization through </span>
  <span class="comment">// MobileEyes.  To disable that behavior, use this constructor call instead:</span>
  <span class="comment">// ArServerHandlerLocalization serverLocHandler(&amp;server, &amp;robot, true, false);</span>
  <span class="comment">// The fifth argument determines whether to send the command to MobileSim.</span>

  <span class="comment">// Provide the map to the client (and related controls):</span>
  ArServerHandlerMap serverMap(&amp;server, &amp;map);

  <span class="comment">// These objects add some simple (custom) commands to &#39;commands&#39; for testing and debugging:</span>
  ArServerSimpleComUC uCCommands(&amp;commands, &amp;robot);                   <span class="comment">// Send any command to the microcontroller</span>
  ArServerSimpleComMovementLogging loggingCommands(&amp;commands, &amp;robot); <span class="comment">// configure logging</span>
  ArServerSimpleComLogRobotConfig configCommands(&amp;commands, &amp;robot);   <span class="comment">// trigger logging of the robot config parameters</span>
<span class="comment">//  ArServerSimpleServerCommands serverCommands(&amp;commands, &amp;server);     // monitor networking behavior (track packets sent etc.)</span>


  <span class="comment">// service that allows the client to monitor the communication link status</span>
  <span class="comment">// between the robot and the client.</span>
  <span class="comment">//</span>
  ArServerHandlerCommMonitor handlerCommMonitor(&amp;server);



  <span class="comment">// service that allows client to change configuration parameters in ArConfig </span>
  ArServerHandlerConfig handlerConfig(&amp;server, Aria::getConfig(),
                      Arnl::getTypicalDefaultParamFileName(),
                      Aria::getDirectory());


  <span class="comment">// This service causes the client to show simple dialog boxes</span>
  ArServerHandlerPopup popupServer(&amp;server);




  <span class="comment">/* Set up the possible modes for remote control from a client such as</span>
<span class="comment">   * MobileEyes:</span>
<span class="comment">   */</span>

  <span class="comment">// Mode To stop and remain stopped:</span>
  ArServerModeStop modeStop(&amp;server, &amp;robot);

  <span class="comment">// Cause the sonar to turn off automatically</span>
  <span class="comment">// when the robot is stopped, and turn it back on when commands to move</span>
  <span class="comment">// are sent. (Note, if using SONARNL to localize, then don&#39;t do this</span>
  <span class="comment">// since localization may get lost)</span>
  ArSonarAutoDisabler sonarAutoDisabler(&amp;robot);

  <span class="comment">// Teleoperation modes To drive by keyboard, joystick, etc:</span>
  ArServerModeRatioDrive modeRatioDrive(&amp;server, &amp;robot);  



  <span class="comment">// Prevent normal teleoperation driving if localization is lost using</span>
  <span class="comment">// a high-priority action, which enables itself when the particular mode is</span>
  <span class="comment">// active.</span>
  <span class="comment">// (You have to enter unsafe drive mode to drive when lost.)</span>
  <a name="_a4"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArActionLost.html">ArActionLost</a> actionLostRatioDrive(&amp;locTask, NULL, &amp;modeRatioDrive);
  modeRatioDrive.getActionGroup()-&gt;addAction(&amp;actionLostRatioDrive, 110);

  <span class="comment">// Add drive mode section to the configuration, and also some custom (simple) commands:</span>
  modeRatioDrive.addToConfig(Aria::getConfig(), <span class="stringliteral">&quot;Teleop settings&quot;</span>);
  modeRatioDrive.addControlCommands(&amp;commands);

  <span class="comment">// Wander mode (also prevent wandering if lost):</span>
  ArServerModeWander modeWander(&amp;server, &amp;robot);
  <a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArActionLost.html">ArActionLost</a> actionLostWander(&amp;locTask, NULL, &amp;modeWander);
  modeWander.getActionGroup()-&gt;addAction(&amp;actionLostWander, 110);

  <span class="comment">// Tool to log data periodically to a file</span>
  ArDataLogger dataLogger(&amp;robot, <span class="stringliteral">&quot;datalog.txt&quot;</span>);
  dataLogger.addToConfig(Aria::getConfig()); <span class="comment">// make it configurable through ArConfig</span>

  <span class="comment">// Automatically add anything from the global info group to the data logger.</span>
  Aria::getInfoGroup()-&gt;addAddStringCallback(dataLogger.getAddStringFunctor());

  <span class="comment">// This provides a small table of interesting information for the client</span>
  <span class="comment">// to display to the operator. You can add your own callbacks to show any</span>
  <span class="comment">// data you want.</span>
  ArServerInfoStrings stringInfo(&amp;server);
  Aria::getInfoGroup()-&gt;addAddStringCallback(stringInfo.getAddStringFunctor());
  
  <span class="comment">// The following statements add fields to a set of informational data called</span>
  <span class="comment">// the InfoGroup. These are served to MobileEyes for displayi (turn on by enabling Details</span>
  <span class="comment">// and Custom Details in the View menu of MobileEyes.)</span>

  Aria::getInfoGroup()-&gt;addStringInt(
      <span class="stringliteral">&quot;Motor Packet Count&quot;</span>, 10, 
      <span class="keyword">new</span> ArConstRetFunctorC&lt;int, ArRobot&gt;(&amp;robot, 
                           &amp;ArRobot::getMotorPacCount));

  Aria::getInfoGroup()-&gt;addStringDouble(
      <span class="stringliteral">&quot;Laser Localization Score&quot;</span>, 8, 
      <span class="keyword">new</span> ArRetFunctorC&lt;double, ArLocalizationTask&gt;(
          &amp;locTask, &amp;<a name="a5"></a><a class="code" href="classArLocalizationTask.html#a17ff3d74dfa7cd4955c284a954e2ba03" title="Gets the higher of MCL and Reflector based localization.">ArLocalizationTask::getLocalizationScore</a>),
      <span class="stringliteral">&quot;%.03f&quot;</span>);
  Aria::getInfoGroup()-&gt;addStringInt(
      <span class="stringliteral">&quot;Laser Loc Num Samples&quot;</span>, 8, 
      <span class="keyword">new</span> ArRetFunctorC&lt;int, ArLocalizationTask&gt;(
          &amp;locTask, &amp;<a name="a6"></a><a class="code" href="classArLocalizationTask.html#af05fb6f78dbb52b3937698ef467e3d1a" title="Get the variable number of samples if adjusted during move.">ArLocalizationTask::getCurrentNumSamples</a>),
      <span class="stringliteral">&quot;%4d&quot;</span>);


  <span class="comment">// Display gyro status if gyro is enabled and is being handled by the firmware (gyro types 2, 3, or 4).</span>
  <span class="comment">// (If the firmware detects an error communicating with the gyro or IMU it</span>
  <span class="comment">// returns a flag, and stops using it.)</span>
  <span class="comment">// (This gyro type parameter, and fault flag, are only in ARCOS, not Seekur firmware)</span>
  <span class="keywordflow">if</span>(robot.getOrigRobotConfig() &amp;&amp; robot.getOrigRobotConfig()-&gt;getGyroType() &gt; 1)
  {
    Aria::getInfoGroup()-&gt;addStringString(
          <span class="stringliteral">&quot;Gyro/IMU Status&quot;</span>, 10,
          <span class="keyword">new</span> ArGlobalRetFunctor1&lt;const char*, ArRobot*&gt;(&amp;getGyroStatusString, &amp;robot)
      );
  }

  <span class="comment">// Display system CPU and wireless network status</span>
  ArSystemStatus::startPeriodicUpdate(1000); <span class="comment">// update every 1 second</span>
  Aria::getInfoGroup()-&gt;addStringDouble(<span class="stringliteral">&quot;CPU Use&quot;</span>, 10, ArSystemStatus::getCPUPercentFunctor(), <span class="stringliteral">&quot;% 4.0f%%&quot;</span>);
  Aria::getInfoGroup()-&gt;addStringInt(<span class="stringliteral">&quot;Wireless Link Quality&quot;</span>, 9, ArSystemStatus::getWirelessLinkQualityFunctor(), <span class="stringliteral">&quot;%d&quot;</span>);
  Aria::getInfoGroup()-&gt;addStringInt(<span class="stringliteral">&quot;Wireless Link Noise&quot;</span>, 9, ArSystemStatus::getWirelessLinkNoiseFunctor(), <span class="stringliteral">&quot;%d&quot;</span>);
  Aria::getInfoGroup()-&gt;addStringInt(<span class="stringliteral">&quot;Wireless Signal&quot;</span>, 9, ArSystemStatus::getWirelessLinkSignalFunctor(), <span class="stringliteral">&quot;%d&quot;</span>);
  

  <span class="comment">// stats on how far its driven since software started</span>
  Aria::getInfoGroup()-&gt;addStringDouble(<span class="stringliteral">&quot;Distance Travelled (m)&quot;</span>, 20, <span class="keyword">new</span> ArRetFunctorC&lt;double, ArRobot&gt;(&amp;robot, &amp;ArRobot::getOdometerDistanceMeters), <span class="stringliteral">&quot;%.2f&quot;</span>);
  Aria::getInfoGroup()-&gt;addStringDouble(<span class="stringliteral">&quot;Run time (min)&quot;</span>, 20, <span class="keyword">new</span>
ArRetFunctorC&lt;double, ArRobot&gt;(&amp;robot, &amp;ArRobot::getOdometerTimeMinutes),
<span class="stringliteral">&quot;%.2f&quot;</span>);




  <span class="comment">// Make Stop mode the default (If current mode deactivates without entering</span>
  <span class="comment">// a new mode, then Stop Mode will be selected)</span>
  modeStop.addAsDefaultMode();
    <span class="comment">// TODO move up near where stop mode is created?</span>





  <span class="comment">/* Services that allow the client to initiate scanning with the laser to</span>
<span class="comment">     create maps in Mapper3 (So not possible with SONARNL): */</span>

  ArServerHandlerMapping handlerMapping(&amp;server, &amp;robot, firstLaser, 
                    fileDir, <span class="stringliteral">&quot;&quot;</span>, <span class="keyword">true</span>);

  <span class="comment">// make laser localization stop while mapping</span>
  handlerMapping.addMappingStartCallback(
      <span class="keyword">new</span> ArFunctor1C&lt;ArLocalizationTask, bool&gt;
      (&amp;locTask, &amp;<a name="a7"></a><a class="code" href="classArLocalizationTask.html#a8347691797bdba24fa53bb668be7d12e" title="Sets the idle flag.">ArLocalizationTask::setIdleFlag</a>, <span class="keyword">true</span>));

  <span class="comment">// and then make it start again when we&#39;re doine</span>
  handlerMapping.addMappingEndCallback(
      <span class="keyword">new</span> ArFunctor1C&lt;ArLocalizationTask, bool&gt;
      (&amp;locTask, &amp;<a class="code" href="classArLocalizationTask.html#a8347691797bdba24fa53bb668be7d12e" title="Sets the idle flag.">ArLocalizationTask::setIdleFlag</a>, <span class="keyword">false</span>));


  <span class="comment">// Make it so our &quot;lost&quot; actions don&#39;t stop us while mapping</span>
  handlerMapping.addMappingStartCallback(actionLostRatioDrive.getDisableCB());
  handlerMapping.addMappingStartCallback(actionLostWander.getDisableCB());

  <span class="comment">// And then let them make us stop as usual when done mapping</span>
  handlerMapping.addMappingEndCallback(actionLostRatioDrive.getEnableCB());
  handlerMapping.addMappingEndCallback(actionLostWander.getEnableCB());


  <span class="comment">/*</span>
<span class="comment">  // If we are on a simulator, move the robot back to its starting position,</span>
<span class="comment">  // and reset its odometry.</span>
<span class="comment">  // This will allow localizeRobotAtHomeBlocking() below will (probably) work (it</span>
<span class="comment">  // tries current odometry (which will be 0,0,0) and all the map</span>
<span class="comment">  // home points.</span>
<span class="comment">  // (Ignored by a real robot)</span>
<span class="comment">  //robot.com(ArCommands::SIM_RESET);</span>
<span class="comment">  */</span>


  <span class="comment">// create a pose storage class, this will let the program keep track</span>
  <span class="comment">// of where the robot is between runs...  after we try and restore</span>
  <span class="comment">// from this file it will start saving the robot&#39;s pose into the</span>
  <span class="comment">// file</span>
  <a name="_a8"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArPoseStorage.html">ArPoseStorage</a> poseStorage(&amp;robot);
  <span class="keywordflow">if</span> (poseStorage.restorePose(<span class="stringliteral">&quot;robotPose&quot;</span>))
    serverLocHandler.setSimPose(robot.getPose());
  <span class="comment">//else</span>
 <span class="comment">//   robot.com(ArCommands::SIM_RESET);</span>



  <span class="comment">/* File transfer services: */</span>
  
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>  <span class="comment">// Not implemented for Windows yet.</span>
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Note, file upload/download services are not implemented for Windows; not enabling them.&quot;</span>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="comment">// This block will allow you to set up where you get and put files</span>
  <span class="comment">// to/from, just comment them out if you don&#39;t want this to happen</span>
  <span class="comment">// /*</span>
  ArServerFileLister fileLister(&amp;server, fileDir);
  ArServerFileToClient fileToClient(&amp;server, fileDir);
  ArServerFileFromClient fileFromClient(&amp;server, fileDir, <span class="stringliteral">&quot;/tmp&quot;</span>);
  ArServerDeleteFileOnServer deleteFileOnServer(&amp;server, fileDir);
  <span class="comment">// */</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="comment">/* Video image streaming, and camera controls (Requires SAVserver or ACTS) */</span>

  <span class="comment">// Forward one video stream if either ACTS, ArVideo videoSubServer, </span>
  <span class="comment">// or SAV server are running.</span>
  <span class="comment">// ArHybridForwarderVideo allows this program to be separate from the ArVideo</span>
  <span class="comment">// library. You could replace videoForwarder and the PTZ connection code below</span>
  <span class="comment">// with a call to ArVideo::createVideoServers(), and link the program to the</span>
  <span class="comment">// ArVideo library if you want to include video capture in the same program</span>
  <span class="comment">// as robot control.</span>
  ArHybridForwarderVideo videoForwarder(&amp;server, <span class="stringliteral">&quot;localhost&quot;</span>, 7070);
  
  <span class="comment">// connect to first configured camera PTZ controls (in robot parameter file and</span>
  <span class="comment">// command line options)</span>
  ptzConnector.connect();
  ArCameraCollection cameraCollection;
  ArPTZ *ptz = ptzConnector.getPTZ(0);
  <span class="keywordflow">if</span>(ptz)
  {
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Connected to PTZ Camera&quot;</span>);
    cameraCollection.addCamera(<span class="stringliteral">&quot;Camera1&quot;</span>, ptz-&gt;getTypeName(), <span class="stringliteral">&quot;Camera&quot;</span>, ptz-&gt;getTypeName());

    videoForwarder.setCameraName(<span class="stringliteral">&quot;Camera1&quot;</span>);
    videoForwarder.addToCameraCollection(cameraCollection);

    <span class="keyword">new</span> ArServerHandlerCamera(<span class="stringliteral">&quot;Camera1&quot;</span>, 
      &amp;server, 
      &amp;robot,
      ptz, 
      &amp;cameraCollection);

  } 

  <span class="comment">// Allows client to find any camera servers created above</span>
  ArServerHandlerCameraCollection cameraCollectionServer(&amp;server, &amp;cameraCollection);



    <span class="comment">/* Load configuration values, map, and begin! */</span>

  
  <span class="comment">// When parsing the configuration file, also look at the program&#39;s command line options </span>
  <span class="comment">// from the command-line argument parser as well as the configuration file.</span>
  <span class="comment">// (So you can use any argument on the command line, namely -map.) </span>
  Aria::getConfig()-&gt;useArgumentParser(&amp;parser);

  <span class="comment">// Read in parameter files.</span>
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Loading config file %s%s into ArConfig...&quot;</span>, Aria::getDirectory(), Arnl::getTypicalParamFileName());
  <span class="keywordflow">if</span> (!Aria::getConfig()-&gt;parseFile(Arnl::getTypicalParamFileName()))
  {
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Could not load ARNL configuration file. Set ARNL environment variable to use non-default installation director.y&quot;</span>);
    Aria::exit(5);
  }

  <span class="comment">// Warn about unknown params.</span>
  <span class="keywordflow">if</span> (!simpleOpener.checkAndLog() || !parser.checkHelpAndWarnUnparsed())
  {
    logOptions(argv[0]);
    Aria::exit(6);
  }

  <span class="comment">// Warn if there is no map</span>
  <span class="keywordflow">if</span> (map.getFileName() == NULL || strlen(map.getFileName()) &lt;= 0)
  {
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;### No map file is set up, you can make a map with the following procedure&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   0) You can find this information in README.txt or docs/Mapping.txt&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   1) Connect to this server with MobileEyes&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   2) Go to Tools-&gt;Map Creation-&gt;Start Scan&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   3) Give the map a name and hit okay&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   4) Drive the robot around your space (see docs/Mapping.txt&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   5) Go to Tools-&gt;Map Creation-&gt;Stop Scan&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   6) Start up Mapper3&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   7) Go to File-&gt;Open on Robot&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   8) Select the .2d you created&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   9) Create a .map&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;  10) Go to File-&gt;Save on Robot&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;  11) In MobileEyes, go to Tools-&gt;Robot Config&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;  12) Choose the Files section&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;  13) Enter the path and name of your new .map file for the value of the Map parameter.&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;  14) Press OK and your new map should become the map used&quot;</span>);
    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;&quot;</span>);    
  }

  <span class="comment">// Print a log message notifying user of the directory for map files</span>
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;&quot;</span>);
  ArLog::log(ArLog::Normal, 
         <span class="stringliteral">&quot;Directory for maps and file serving: %s&quot;</span>, fileDir);
  
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;See the ARNL README.txt for more information&quot;</span>);
  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;&quot;</span>);

  <span class="comment">// Do an initial localization of the robot. ARNL and SONARNL try all the home points</span>
  <span class="comment">// in the map, as well as the robot&#39;s current odometric position, as possible</span>
  <span class="comment">// places the robot is likely to be at startup.   If successful, it will</span>
  <span class="comment">// also save the position it found to be the best localized position as the</span>
  <span class="comment">// &quot;Home&quot; position, which can be obtained from the localization task (and is</span>
  <span class="comment">// used by the &quot;Go to home&quot; network request).</span>
  <span class="comment">// MOGS instead just initializes at the current GPS position.</span>
  <span class="comment">// (You will stil have to drive the robot so it can determine the robot&#39;s</span>
  <span class="comment">// heading, however. See GPS Mapping instructions.)</span>
  locTask.localizeRobotAtHomeBlocking();
  
  <span class="comment">// Let the client switch manager (for multirobot) spin off into its own thread</span>
  <span class="comment">// TODO move to multirobot example?</span>
  clientSwitch.runAsync();

  <span class="comment">// Start the networking server&#39;s thread</span>
  server.runAsync();

  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Server running. To exit, press CTRL-C.&quot;</span>);

  <span class="comment">// Enable the motors and wait until the robot exits (disconnection, etc.) or this program is</span>
  <span class="comment">// canceled.</span>
  robot.enableMotors();
  robot.waitForRunExit();
  Aria::exit(0);
}

</pre></div> </div><!-- contents -->
</div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>

    <li class="footer">Generated on Thu Oct 30 2014 14:13:22 for ARNL by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
